name: 'Professional Release Build'

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Get version
        run: echo "PACKAGE_VERSION=$(node -pe "require('./tauri-app/package.json').version")" >> $GITHUB_ENV
      - name: Create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}`,
              name: `FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ v${process.env.PACKAGE_VERSION}`,
              body: `
              ## ğŸ‰ FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ v${process.env.PACKAGE_VERSION}
              
              ### âœ¨ æ–°åŠŸèƒ½
              - ğŸ”„ åŒç®—æ³•æ”¯æŒï¼šFIFO + å·®é¢è®¡ç®—æ³•
              - ğŸ“Š ä¸“ä¸šå®¡è®¡åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ
              - ğŸ” æ—¶ç‚¹æŸ¥è¯¢å’Œå†å²è®°å½•ç®¡ç†
              - ğŸŒ™ æ·±æµ…ä¸»é¢˜å’Œä¸­è‹±æ–‡åˆ‡æ¢
              - âš¡ é«˜æ€§èƒ½æ•°æ®å¤„ç†ï¼ˆæ”¯æŒ50ä¸‡è¡Œï¼‰
              
              ### ğŸ“¦ å®‰è£…æ–¹å¼
              
              **Windowsç”¨æˆ·**ï¼š
              1. ä¸‹è½½ \`FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ_${process.env.PACKAGE_VERSION}_x64_zh-CN.msi\`
              2. åŒå‡»å®‰è£…åŒ…ï¼ŒæŒ‰æç¤ºå®‰è£…
              3. å¯åŠ¨åº”ç”¨ç¨‹åº
              
              **ä¾¿æºç‰ˆæœ¬**ï¼š
              1. ä¸‹è½½ \`FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ.exe\`
              2. ç›´æ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…
              
              ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
              åº”ç”¨ç¨‹åºæ”¯æŒè‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼Œç¡®ä¿æ‚¨å§‹ç»ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚
              
              ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
              - Windows 10/11 (64ä½)
              - å†…å­˜ï¼šè‡³å°‘ 4GB RAM
              - ç£ç›˜ç©ºé—´ï¼šè‡³å°‘ 100MB
              
              ### ğŸ› ï¸ æŠ€æœ¯æ”¯æŒ
              å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
              `,
              draft: false,
              prerelease: false
            });
            return data.id;

  build-tauri:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'
          cache-dependency-path: tauri-app/package-lock.json
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'windows-latest' && 'x86_64-pc-windows-msvc' || '' }}
          
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './tauri-app/src-tauri -> target'
          
      - name: Install frontend dependencies
        working-directory: ./tauri-app
        run: npm ci
        
      - name: Build the app
        working-directory: ./tauri-app
        run: |
          npm run tauri build -- --verbose ${{ matrix.args }}
        env:
          # ç”Ÿäº§ç¯å¢ƒå˜é‡
          NODE_ENV: production
          # å¦‚æœæœ‰ä»£ç ç­¾åè¯ä¹¦ï¼Œåœ¨è¿™é‡Œé…ç½®
          # WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          # WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
          
      - name: Upload Release Asset (MSI)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./tauri-app/src-tauri/target/release/bundle/msi/FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ_${{ env.PACKAGE_VERSION }}_x64_zh-CN.msi
          asset_name: FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ_${{ env.PACKAGE_VERSION }}_x64_zh-CN.msi
          asset_content_type: application/x-msi
          
      - name: Upload Release Asset (Portable EXE)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./tauri-app/src-tauri/target/release/FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ.exe
          asset_name: FIFOèµ„é‡‘è¿½è¸ªå®¡è®¡ç³»ç»Ÿ.exe
          asset_content_type: application/x-msdownload
          
      # ç”Ÿæˆæ›´æ–°ä¿¡æ¯
      - name: Generate update signatures
        if: matrix.platform == 'windows-latest'
        working-directory: ./tauri-app
        run: |
          # è¿™é‡Œéœ€è¦ç”Ÿæˆæ›´æ–°ç­¾åï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦é…ç½®ç§é’¥
          echo "ç”Ÿæˆæ›´æ–°ç­¾åæ–‡ä»¶..."
          # npm run tauri signer generate -- -w ${{ secrets.UPDATER_PRIVATE_KEY }}