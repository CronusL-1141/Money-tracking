"""
å·®é¢è®¡ç®—æ³•è¿½è¸ªå™¨
å®ç°ä½™é¢ä¼˜å…ˆæ‰£é™¤çš„å·®é¢è®¡ç®—æ³•ï¼Œæœ€å¤§åŒ–å¤ç”¨ç°æœ‰æ¨¡å—
"""

from typing import Tuple, Dict, Any, Optional
import pandas as pd

from core.interfaces.tracker_interface import ITracker
from config import Config
from utils.logger import audit_logger
from models.behavior_analyzer import BehaviorAnalyzer


class BalanceMethodTracker(ITracker):
    """å·®é¢è®¡ç®—æ³•è¿½è¸ªå™¨ - ä¸ªäººä½™é¢ä¼˜å…ˆæ‰£é™¤"""
    
    def __init__(self):
        """åˆå§‹åŒ–å·®é¢è®¡ç®—æ³•è¿½è¸ªå™¨"""
        # ç®€åŒ–çš„ä½™é¢ç®¡ç†ï¼ˆæ›¿ä»£FIFOé˜Ÿåˆ—ï¼‰
        self._ä¸ªäººä½™é¢ = 0.0
        self._å…¬å¸ä½™é¢ = 0.0
        self._å·²åˆå§‹åŒ– = False
        
        # ç´¯è®¡ç»Ÿè®¡
        self._ç´¯è®¡æŒªç”¨é‡‘é¢ = 0.0
        self._ç´¯è®¡å«ä»˜é‡‘é¢ = 0.0  
        self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘ = 0.0
        self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘ = 0.0
        self._ç´¯è®¡éæ³•æ‰€å¾— = 0.0
        self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦ = 0.0
        self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦ = 0.0
        
        # åœºå¤–èµ„é‡‘æ± ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        self._æŠ•èµ„äº§å“èµ„é‡‘æ±  = {}
        self._åœºå¤–èµ„é‡‘æ± è®°å½• = []
        
        # å¤ç”¨ç°æœ‰çš„è¡Œä¸ºåˆ†æå™¨
        self._è¡Œä¸ºåˆ†æå™¨ = BehaviorAnalyzer()
        
        audit_logger.debug("å·®é¢è®¡ç®—æ³•è¿½è¸ªå™¨åˆå§‹åŒ–å®Œæˆ")
    
    def åˆå§‹åŒ–ä½™é¢(self, åˆå§‹ä½™é¢: float, ä½™é¢ç±»å‹: str = 'å…¬å¸') -> None:
        """åˆå§‹åŒ–ä½™é¢"""
        if not self._å·²åˆå§‹åŒ– and åˆå§‹ä½™é¢ > 0:
            if ä½™é¢ç±»å‹ == 'å…¬å¸':
                self._å…¬å¸ä½™é¢ = åˆå§‹ä½™é¢
            else:
                self._ä¸ªäººä½™é¢ = åˆå§‹ä½™é¢
            self._å·²åˆå§‹åŒ– = True
            audit_logger.debug(f"å·®é¢è®¡ç®—æ³•åˆå§‹åŒ–ä½™é¢: {åˆå§‹ä½™é¢:,.2f} (è®¾ä¸º{ä½™é¢ç±»å‹}ä½™é¢)")
    
    def å¤„ç†èµ„é‡‘æµå…¥(self, é‡‘é¢: float, èµ„é‡‘å±æ€§: str, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> Tuple[float, float, str]:
        """
        å¤„ç†èµ„é‡‘æµå…¥ - å¤ç”¨FIFOçš„åˆ†é…è§„åˆ™
        æ”¶å…¥åˆ†é…è§„åˆ™ä¸FIFOç›¸åŒï¼Œç¡®ä¿ä¸€è‡´æ€§
        """
        if é‡‘é¢ <= 0:
            return 0, 0, ""
        
        # å¤ç”¨FIFOçš„æ”¶å…¥åˆ†é…é€»è¾‘
        if Config.is_personal_fund(èµ„é‡‘å±æ€§):
            # ä¸ªäººèµ„é‡‘
            self._ä¸ªäººä½™é¢ += é‡‘é¢
            return 1.0, 0.0, f"ä¸ªäººèµ„é‡‘æµå…¥ï¼š{é‡‘é¢:,.2f}"
            
        elif Config.is_company_fund(èµ„é‡‘å±æ€§):
            # å…¬å¸èµ„é‡‘
            self._å…¬å¸ä½™é¢ += é‡‘é¢
            return 0.0, 1.0, f"å…¬å¸èµ„é‡‘æµå…¥ï¼š{é‡‘é¢:,.2f}"
            
        else:
            # å…¶ä»–æƒ…å†µï¼ŒæŒ‰å½“å‰ä½™é¢æ¯”ä¾‹åˆ†é…ï¼ˆä¸FIFOé€»è¾‘ä¸€è‡´ï¼‰
            total_balance = self._ä¸ªäººä½™é¢ + self._å…¬å¸ä½™é¢
            if total_balance == 0:
                # å¦‚æœæ€»ä½™é¢ä¸º0ï¼ŒæŒ‰é»˜è®¤è§„åˆ™å¤„ç†
                audit_logger.warning(f"èµ„é‡‘æ± ä¸ºç©ºï¼Œæ”¶åˆ°{é‡‘é¢:,.2f}ï¼ŒæŒ‰é»˜è®¤è§„åˆ™å¤„ç†")
                # é»˜è®¤æŒ‰1:1åˆ†é…
                ä¸ªäººé‡‘é¢ = é‡‘é¢ / 2
                å…¬å¸é‡‘é¢ = é‡‘é¢ / 2
                self._ä¸ªäººä½™é¢ += ä¸ªäººé‡‘é¢
                self._å…¬å¸ä½™é¢ += å…¬å¸é‡‘é¢
                return 0.5, 0.5, f"æ··åˆèµ„é‡‘æµå…¥ï¼šä¸ªäºº{ä¸ªäººé‡‘é¢:,.2f}ï¼Œå…¬å¸{å…¬å¸é‡‘é¢:,.2f}"
            else:
                ä¸ªäººå æ¯” = self._ä¸ªäººä½™é¢ / total_balance
                å…¬å¸å æ¯” = self._å…¬å¸ä½™é¢ / total_balance
                ä¸ªäººé‡‘é¢ = é‡‘é¢ * ä¸ªäººå æ¯”
                å…¬å¸é‡‘é¢ = é‡‘é¢ * å…¬å¸å æ¯”
                self._ä¸ªäººä½™é¢ += ä¸ªäººé‡‘é¢
                self._å…¬å¸ä½™é¢ += å…¬å¸é‡‘é¢
                return ä¸ªäººå æ¯”, å…¬å¸å æ¯”, f"æ··åˆèµ„é‡‘æµå…¥ï¼šä¸ªäºº{ä¸ªäººé‡‘é¢:,.2f}ï¼Œå…¬å¸{å…¬å¸é‡‘é¢:,.2f}"
    
    def å¤„ç†èµ„é‡‘æµå‡º(self, é‡‘é¢: float, èµ„é‡‘å±æ€§: str, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> Tuple[float, float, str]:
        """
        å¤„ç†èµ„é‡‘æµå‡º - å·®é¢è®¡ç®—æ³•æ ¸å¿ƒé€»è¾‘
        ä¸ªäººä½™é¢ä¼˜å…ˆæ‰£é™¤ï¼Œä¸è¶³éƒ¨åˆ†ç®—æŒªç”¨
        """
        if é‡‘é¢ <= 0:
            return 0, 0, ""
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæŠ•èµ„äº§å“ç”³è´­
        if Config.is_investment_product(èµ„é‡‘å±æ€§):
            return self._å¤„ç†æŠ•èµ„äº§å“ç”³è´­(é‡‘é¢, èµ„é‡‘å±æ€§, äº¤æ˜“æ—¥æœŸ)
        else:
            return self._å¤„ç†æ™®é€šèµ„é‡‘æµå‡º(é‡‘é¢, èµ„é‡‘å±æ€§, äº¤æ˜“æ—¥æœŸ)
    
    def _å¤„ç†æ™®é€šèµ„é‡‘æµå‡º(self, é‡‘é¢: float, èµ„é‡‘å±æ€§: str, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> Tuple[float, float, str]:
        """
        å¤„ç†æ™®é€šèµ„é‡‘æµå‡º - å·®é¢è®¡ç®—æ³•æ ¸å¿ƒ
        æ ¹æ®èµ„é‡‘å±æ€§å†³å®šä¼˜å…ˆæ‰£é™¤å“ªä¸ªä½™é¢
        """
        # æ£€æŸ¥æ€»å¯ç”¨èµ„é‡‘
        total_available = self._ä¸ªäººä½™é¢ + self._å…¬å¸ä½™é¢
        if total_available <= 0:
            audit_logger.warning(f"èµ„é‡‘æ± å·²ç©ºï¼Œæ— æ³•æ”¯å‡º{é‡‘é¢:,.2f}")
            return 0, 0, f"èµ„é‡‘æ± å·²ç©ºï¼Œæ— æ³•æ”¯å‡º{é‡‘é¢:,.2f}"
        
        # å·®é¢è®¡ç®—æ³•æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®æ”¯å‡ºæ€§è´¨å†³å®šä¼˜å…ˆæ‰£é™¤é€»è¾‘
        if Config.is_personal_fund(èµ„é‡‘å±æ€§):
            # ä¸ªäººåº”ä»˜æ”¯å‡ºï¼šä¸ªäººä½™é¢ä¼˜å…ˆæ‰£é™¤
            ä¸ªäººæ‰£é™¤ = min(é‡‘é¢, self._ä¸ªäººä½™é¢)
            å‰©ä½™é‡‘é¢ = é‡‘é¢ - ä¸ªäººæ‰£é™¤
            å…¬å¸æ‰£é™¤ = min(å‰©ä½™é‡‘é¢, self._å…¬å¸ä½™é¢)
            
            # ä¸ªäººæ”¯å‡ºä½¿ç”¨å…¬å¸èµ„é‡‘ = æŒªç”¨
            if å…¬å¸æ‰£é™¤ > 0:
                self._ç´¯è®¡æŒªç”¨é‡‘é¢ += å…¬å¸æ‰£é™¤
                
        elif Config.is_company_fund(èµ„é‡‘å±æ€§):
            # å…¬å¸åº”ä»˜æ”¯å‡ºï¼šå…¬å¸ä½™é¢ä¼˜å…ˆæ‰£é™¤
            å…¬å¸æ‰£é™¤ = min(é‡‘é¢, self._å…¬å¸ä½™é¢)
            å‰©ä½™é‡‘é¢ = é‡‘é¢ - å…¬å¸æ‰£é™¤
            ä¸ªäººæ‰£é™¤ = min(å‰©ä½™é‡‘é¢, self._ä¸ªäººä½™é¢)
            
            # å…¬å¸æ”¯å‡ºä½¿ç”¨ä¸ªäººèµ„é‡‘ = å«ä»˜
            if ä¸ªäººæ‰£é™¤ > 0:
                self._ç´¯è®¡å«ä»˜é‡‘é¢ += ä¸ªäººæ‰£é™¤
                
        else:
            # å…¶ä»–æƒ…å†µï¼šæŒ‰åŸä¸ªäººä¼˜å…ˆé€»è¾‘ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
            ä¸ªäººæ‰£é™¤ = min(é‡‘é¢, self._ä¸ªäººä½™é¢)
            å‰©ä½™é‡‘é¢ = é‡‘é¢ - ä¸ªäººæ‰£é™¤
            å…¬å¸æ‰£é™¤ = min(å‰©ä½™é‡‘é¢, self._å…¬å¸ä½™é¢)
        
        èµ„é‡‘ç¼ºå£ = é‡‘é¢ - ä¸ªäººæ‰£é™¤ - å…¬å¸æ‰£é™¤
        
        # æ›´æ–°ä½™é¢
        self._ä¸ªäººä½™é¢ -= ä¸ªäººæ‰£é™¤
        self._å…¬å¸ä½™é¢ -= å…¬å¸æ‰£é™¤
        
        # æ ¼å¼åŒ–æ•°å€¼
        self._ç´¯è®¡æŒªç”¨é‡‘é¢ = Config.format_number(self._ç´¯è®¡æŒªç”¨é‡‘é¢)
        self._ç´¯è®¡å«ä»˜é‡‘é¢ = Config.format_number(self._ç´¯è®¡å«ä»˜é‡‘é¢)
        
        # å¤ç”¨BehaviorAnalyzerè¿›è¡Œè¡Œä¸ºåˆ†æ
        è¡Œä¸ºæ€§è´¨ = self._è¡Œä¸ºåˆ†æå™¨.åˆ†æè¡Œä¸ºæ€§è´¨(èµ„é‡‘å±æ€§, ä¸ªäººæ‰£é™¤, å…¬å¸æ‰£é™¤, é‡‘é¢)
        
        # è®¡ç®—å æ¯”
        å®é™…æ”¯å‡º = ä¸ªäººæ‰£é™¤ + å…¬å¸æ‰£é™¤
        if å®é™…æ”¯å‡º > 0:
            ä¸ªäººå æ¯” = ä¸ªäººæ‰£é™¤ / é‡‘é¢
            å…¬å¸å æ¯” = å…¬å¸æ‰£é™¤ / é‡‘é¢
        else:
            ä¸ªäººå æ¯” = 0
            å…¬å¸å æ¯” = 0
        
        # æ·»åŠ èµ„é‡‘ç¼ºå£è¯´æ˜
        if èµ„é‡‘ç¼ºå£ > Config.BALANCE_TOLERANCE:
            è¡Œä¸ºæ€§è´¨ = f"{è¡Œä¸ºæ€§è´¨}ï¼›èµ„é‡‘ç¼ºå£ï¼š{èµ„é‡‘ç¼ºå£:,.2f}"
        
        return ä¸ªäººå æ¯”, å…¬å¸å æ¯”, è¡Œä¸ºæ€§è´¨
    
    def _å¤„ç†æŠ•èµ„äº§å“ç”³è´­(self, é‡‘é¢: float, èµ„é‡‘å±æ€§: str, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> Tuple[float, float, str]:
        """
        å¤„ç†æŠ•èµ„äº§å“ç”³è´­ - æŠ•èµ„é€šå¸¸ä¸ºä¸ªäººè¡Œä¸ºï¼Œä¸ªäººä½™é¢ä¼˜å…ˆæ‰£é™¤
        """
        # æŠ•èµ„äº§å“ç”³è´­ï¼šä¸ªäººä½™é¢ä¼˜å…ˆæ‰£é™¤ï¼ˆæŠ•èµ„é€šå¸¸æ˜¯ä¸ªäººè¡Œä¸ºï¼‰
        ä¸ªäººæ‰£é™¤ = min(é‡‘é¢, self._ä¸ªäººä½™é¢)
        å‰©ä½™é‡‘é¢ = é‡‘é¢ - ä¸ªäººæ‰£é™¤
        å…¬å¸æ‰£é™¤ = min(å‰©ä½™é‡‘é¢, self._å…¬å¸ä½™é¢)
        
        # æ›´æ–°ä½™é¢
        self._ä¸ªäººä½™é¢ -= ä¸ªäººæ‰£é™¤
        self._å…¬å¸ä½™é¢ -= å…¬å¸æ‰£é™¤
        
        # æŠ•èµ„ä½¿ç”¨å…¬å¸èµ„é‡‘ç®—æŒªç”¨ï¼ˆä¸ªäººæŠ•èµ„ç”¨å…¬å¸é’±ï¼‰
        if å…¬å¸æ‰£é™¤ > 0:
            self._ç´¯è®¡æŒªç”¨é‡‘é¢ += å…¬å¸æ‰£é™¤
            self._ç´¯è®¡æŒªç”¨é‡‘é¢ = Config.format_number(self._ç´¯è®¡æŒªç”¨é‡‘é¢)
        
        # è®¡ç®—å æ¯”ï¼ˆç›¸å¯¹äºç”³è´­é‡‘é¢ï¼Œè€Œä¸æ˜¯å®é™…æ‰£é™¤é‡‘é¢ï¼‰
        if é‡‘é¢ > 0:
            ä¸ªäººå æ¯” = ä¸ªäººæ‰£é™¤ / é‡‘é¢
            å…¬å¸å æ¯” = å…¬å¸æ‰£é™¤ / é‡‘é¢
        else:
            ä¸ªäººå æ¯” = 0
            å…¬å¸å æ¯” = 0
        
        # æ›´æ–°æŠ•èµ„äº§å“èµ„é‡‘æ± ï¼ˆè®°å½•å æ¯”ç”¨äºèµå›ï¼‰
        self._æ›´æ–°æŠ•èµ„äº§å“èµ„é‡‘æ± (èµ„é‡‘å±æ€§, é‡‘é¢, ä¸ªäººå æ¯”, å…¬å¸å æ¯”, äº¤æ˜“æ—¥æœŸ)
        
        # æ„é€ è¡Œä¸ºæ€§è´¨æè¿°
        å‰ç¼€ = èµ„é‡‘å±æ€§.split('-')[0]
        è¡Œä¸ºæè¿° = []
        if å…¬å¸æ‰£é™¤ > 0:
            è¡Œä¸ºæè¿°.append(f"æŠ•èµ„æŒªç”¨ï¼š{å…¬å¸æ‰£é™¤:,.2f}")
        if ä¸ªäººæ‰£é™¤ > 0:
            è¡Œä¸ºæè¿°.append(f"ä¸ªäººæŠ•èµ„ï¼š{ä¸ªäººæ‰£é™¤:,.2f}")
        
        è¡Œä¸ºæ€§è´¨ = "ï¼›".join(è¡Œä¸ºæè¿°) if è¡Œä¸ºæè¿° else "æ— æŠ•èµ„"
        
        return ä¸ªäººå æ¯”, å…¬å¸å æ¯”, f"{å‰ç¼€}ç”³è´­-{èµ„é‡‘å±æ€§}ï¼š{è¡Œä¸ºæ€§è´¨}"
    
    def _æ›´æ–°æŠ•èµ„äº§å“èµ„é‡‘æ± (self, æŠ•èµ„äº§å“ç¼–å·: str, é‡‘é¢: float, ä¸ªäººå æ¯”: float, å…¬å¸å æ¯”: float, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> None:
        """æ›´æ–°æŠ•èµ„äº§å“èµ„é‡‘æ±  - ç®€åŒ–ç‰ˆæŠ•èµ„äº§å“ç®¡ç†"""
        if æŠ•èµ„äº§å“ç¼–å· not in self._æŠ•èµ„äº§å“èµ„é‡‘æ± :
            self._æŠ•èµ„äº§å“èµ„é‡‘æ± [æŠ•èµ„äº§å“ç¼–å·] = {
                'æ€»é‡‘é¢': 0,
                'ä¸ªäººå æ¯”': 0,
                'å…¬å¸å æ¯”': 0,
                'ç´¯è®¡ç”³è´­': 0,
                'ç´¯è®¡èµå›': 0,
                'ç´¯è®¡ä¸ªäººé‡‘é¢': 0,
                'ç´¯è®¡å…¬å¸é‡‘é¢': 0,
                'å†å²ç›ˆåˆ©è®°å½•': [],  # è®°å½•æ¯æ¬¡é‡ç½®æ—¶çš„ç›ˆåˆ©
                'ç´¯è®¡å·²å®ç°ç›ˆåˆ©': 0   # æ‰€æœ‰é‡ç½®ç›ˆåˆ©çš„ç´¯è®¡
            }
        
        äº§å“ä¿¡æ¯ = self._æŠ•èµ„äº§å“èµ„é‡‘æ± [æŠ•èµ„äº§å“ç¼–å·]
        äº§å“ä¿¡æ¯['æ€»é‡‘é¢'] += é‡‘é¢
        äº§å“ä¿¡æ¯['ç´¯è®¡ç”³è´­'] += é‡‘é¢
        äº§å“ä¿¡æ¯['ç´¯è®¡ä¸ªäººé‡‘é¢'] += é‡‘é¢ * ä¸ªäººå æ¯”
        äº§å“ä¿¡æ¯['ç´¯è®¡å…¬å¸é‡‘é¢'] += é‡‘é¢ * å…¬å¸å æ¯”
        
        # æ›´æ–°å æ¯”ï¼ˆæŒ‰ç´¯è®¡æŠ•å…¥è®¡ç®—ï¼Œä¸FIFOç®—æ³•ä¸€è‡´ï¼‰
        if äº§å“ä¿¡æ¯['æ€»é‡‘é¢'] > 0:
            äº§å“ä¿¡æ¯['ä¸ªäººå æ¯”'] = äº§å“ä¿¡æ¯['ç´¯è®¡ä¸ªäººé‡‘é¢'] / äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
            äº§å“ä¿¡æ¯['å…¬å¸å æ¯”'] = äº§å“ä¿¡æ¯['ç´¯è®¡å…¬å¸é‡‘é¢'] / äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
        
        # è®°å½•äº¤æ˜“
        # è®¡ç®—æ€»èµ„é‡‘å æ¯”ï¼ˆåŸºäºäº§å“ä¿¡æ¯ä¸­çš„ç´¯è®¡èµ„é‡‘ï¼‰
        æ€»é‡‘é¢ = äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
        if æ€»é‡‘é¢ != 0:
            æ€»ä¸ªäººå æ¯” = äº§å“ä¿¡æ¯.get('ç´¯è®¡ä¸ªäººé‡‘é¢', 0) / æ€»é‡‘é¢
            æ€»å…¬å¸å æ¯” = äº§å“ä¿¡æ¯.get('ç´¯è®¡å…¬å¸é‡‘é¢', 0) / æ€»é‡‘é¢
        else:
            æ€»ä¸ªäººå æ¯” = 0
            æ€»å…¬å¸å æ¯” = 0
        
        äº¤æ˜“è®°å½• = {
            'äº¤æ˜“æ—¶é—´': äº¤æ˜“æ—¥æœŸ.strftime('%Y-%m-%d %H:%M:%S') if äº¤æ˜“æ—¥æœŸ is not None else 'æœªçŸ¥æ—¶é—´',
            'èµ„é‡‘æ± åç§°': æŠ•èµ„äº§å“ç¼–å·,
            'å…¥é‡‘': é‡‘é¢,
            'å‡ºé‡‘': 0,
            'æ€»ä½™é¢': äº§å“ä¿¡æ¯['æ€»é‡‘é¢'],
            'å•ç¬”èµ„é‡‘å æ¯”': f"ä¸ªäºº{ä¸ªäººå æ¯”:.1%}ï¼Œå…¬å¸{å…¬å¸å æ¯”:.1%}",
            'æ€»èµ„é‡‘å æ¯”': f"ä¸ªäºº{æ€»ä¸ªäººå æ¯”:.1%}ï¼Œå…¬å¸{æ€»å…¬å¸å æ¯”:.1%}",
            'è¡Œä¸ºæ€§è´¨': f"å…¥é‡‘ï¼ˆä¸ªäºº{é‡‘é¢*ä¸ªäººå æ¯”:,.0f}ï¼Œå…¬å¸{é‡‘é¢*å…¬å¸å æ¯”:,.0f}ï¼‰",
            'ç´¯è®¡ç”³è´­': äº§å“ä¿¡æ¯['ç´¯è®¡ç”³è´­'],
            'ç´¯è®¡èµå›': äº§å“ä¿¡æ¯['ç´¯è®¡èµå›']
        }
        self._åœºå¤–èµ„é‡‘æ± è®°å½•.append(äº¤æ˜“è®°å½•)
    
    def å¤„ç†æŠ•èµ„äº§å“èµå›(self, é‡‘é¢: float, èµ„é‡‘å±æ€§: str, äº¤æ˜“æ—¥æœŸ: Optional[pd.Timestamp]) -> Tuple[float, float, str]:
        """
        å¤„ç†æŠ•èµ„äº§å“èµå› - æŒ‰ç”³è´­æ—¶å æ¯”åˆ†é…æ”¶ç›Š
        """
        if é‡‘é¢ <= 0:
            return 0, 0, ""
        
        æŠ•èµ„äº§å“ç¼–å· = èµ„é‡‘å±æ€§
        if not Config.is_investment_product(èµ„é‡‘å±æ€§):
            return 0, 0, ""
        
        # æŸ¥æ‰¾æŠ•èµ„äº§å“è®°å½•
        if æŠ•èµ„äº§å“ç¼–å· not in self._æŠ•èµ„äº§å“èµ„é‡‘æ± :
            # æ— ç”³è´­è®°å½•ï¼ŒæŒ‰ä¸ªäººåº”æ”¶å¤„ç†
            self._ä¸ªäººä½™é¢ += é‡‘é¢
            å‰ç¼€ = æŠ•èµ„äº§å“ç¼–å·.split('-')[0]
            return 1.0, 0.0, f"{å‰ç¼€}æ”¶å…¥-{æŠ•èµ„äº§å“ç¼–å·}ï¼šä¸ªäººåº”æ”¶{é‡‘é¢:,.2f}ï¼ˆæ— ç”³è´­è®°å½•ï¼‰"
        
        äº§å“ä¿¡æ¯ = self._æŠ•èµ„äº§å“èµ„é‡‘æ± [æŠ•èµ„äº§å“ç¼–å·]
        ä¸ªäººå æ¯” = äº§å“ä¿¡æ¯['ä¸ªäººå æ¯”']
        å…¬å¸å æ¯” = äº§å“ä¿¡æ¯['å…¬å¸å æ¯”']
        
        # æŒ‰ç”³è´­å æ¯”åˆ†é…èµå›æ”¶ç›Š
        ä¸ªäººè¿”è¿˜ = é‡‘é¢ * ä¸ªäººå æ¯”
        å…¬å¸è¿”è¿˜ = é‡‘é¢ * å…¬å¸å æ¯”
        
        # å½’è¿˜åˆ°ä½™é¢
        self._ä¸ªäººä½™é¢ += ä¸ªäººè¿”è¿˜
        self._å…¬å¸ä½™é¢ += å…¬å¸è¿”è¿˜
        
        # è®¡ç®—æœ¬é‡‘å½’è¿˜ï¼ˆç”¨äºæŠµæ¶ˆæŒªç”¨ï¼‰
        ç”³è´­æ€»é¢ = äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
        if ç”³è´­æ€»é¢ > 0:
            èµå›æ¯”ä¾‹ = min(é‡‘é¢ / ç”³è´­æ€»é¢, 1.0)
            å½’è¿˜çš„å…¬å¸æœ¬é‡‘ = ç”³è´­æ€»é¢ * å…¬å¸å æ¯” * èµå›æ¯”ä¾‹
            if å½’è¿˜çš„å…¬å¸æœ¬é‡‘ > 0:
                self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘ += å½’è¿˜çš„å…¬å¸æœ¬é‡‘
                self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘ = Config.format_number(self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘)
                # åŒæ—¶æ›´æ–°ä¸ªäººæœ¬é‡‘å½’è¿˜ï¼ˆå¦‚æœæœ‰ä¸ªäººéƒ¨åˆ†ï¼‰
                if ä¸ªäººå æ¯” > 0:
                    å½’è¿˜çš„ä¸ªäººæœ¬é‡‘ = ç”³è´­æ€»é¢ * ä¸ªäººå æ¯” * èµå›æ¯”ä¾‹
                    self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘ += å½’è¿˜çš„ä¸ªäººæœ¬é‡‘
                    self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘ = Config.format_number(self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘)
        
        # æ›´æ–°äº§å“ä¿¡æ¯ï¼ˆä¸FIFOç®—æ³•ä¸€è‡´ï¼‰
        if ç”³è´­æ€»é¢ > 0:
            èµå›æ¯”ä¾‹ = min(é‡‘é¢ / ç”³è´­æ€»é¢, 1.0)
            å¯¹åº”ç”³è´­æˆæœ¬ = min(é‡‘é¢, ç”³è´­æ€»é¢)
            
            # åŒæ—¶æ›´æ–°ä¸ªäººé‡‘é¢ã€å…¬å¸é‡‘é¢å’Œæ€»é‡‘é¢ï¼ˆä¸FIFOé€»è¾‘ä¸€è‡´ï¼‰
            äº§å“ä¿¡æ¯['ç´¯è®¡ä¸ªäººé‡‘é¢'] -= äº§å“ä¿¡æ¯['ç´¯è®¡ä¸ªäººé‡‘é¢'] * èµå›æ¯”ä¾‹
            äº§å“ä¿¡æ¯['ç´¯è®¡å…¬å¸é‡‘é¢'] -= äº§å“ä¿¡æ¯['ç´¯è®¡å…¬å¸é‡‘é¢'] * èµå›æ¯”ä¾‹
            äº§å“ä¿¡æ¯['æ€»é‡‘é¢'] -= å¯¹åº”ç”³è´­æˆæœ¬
        
        äº§å“ä¿¡æ¯['ç´¯è®¡èµå›'] += é‡‘é¢
        
        # é‡æ–°è®¡ç®—å æ¯”ï¼ˆåŸºäºæ›´æ–°åçš„èµ„é‡‘æ± çŠ¶æ€ï¼Œä¸FIFOç®—æ³•ä¸€è‡´ï¼‰
        if äº§å“ä¿¡æ¯['æ€»é‡‘é¢'] > 0:
            äº§å“ä¿¡æ¯['ä¸ªäººå æ¯”'] = äº§å“ä¿¡æ¯['ç´¯è®¡ä¸ªäººé‡‘é¢'] / äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
            äº§å“ä¿¡æ¯['å…¬å¸å æ¯”'] = äº§å“ä¿¡æ¯['ç´¯è®¡å…¬å¸é‡‘é¢'] / äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
        else:
            # èµ„é‡‘æ± æ¸…ç©ºæ—¶ï¼Œä¿æŒåŸå æ¯”
            pass
        
        # è®¡ç®—æ”¶ç›Š
        æ”¶ç›Š = max(0, é‡‘é¢ - min(é‡‘é¢, ç”³è´­æ€»é¢))
        if æ”¶ç›Š > 0:
            ä¸ªäººæ”¶ç›Š = æ”¶ç›Š * ä¸ªäººå æ¯”
            å…¬å¸æ”¶ç›Š = æ”¶ç›Š * å…¬å¸å æ¯”
            self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦ += ä¸ªäººæ”¶ç›Š
            self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦ += å…¬å¸æ”¶ç›Š
            self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦ = Config.format_number(self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦)
            self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦ = Config.format_number(self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦)
        
        # è®°å½•äº¤æ˜“
        # è®¡ç®—æ€»èµ„é‡‘å æ¯”ï¼ˆåŸºäºäº§å“ä¿¡æ¯ä¸­çš„ç´¯è®¡èµ„é‡‘ï¼‰
        æ€»é‡‘é¢ = äº§å“ä¿¡æ¯['æ€»é‡‘é¢']
        if æ€»é‡‘é¢ != 0:
            æ€»ä¸ªäººå æ¯” = äº§å“ä¿¡æ¯.get('ç´¯è®¡ä¸ªäººé‡‘é¢', 0) / æ€»é‡‘é¢
            æ€»å…¬å¸å æ¯” = äº§å“ä¿¡æ¯.get('ç´¯è®¡å…¬å¸é‡‘é¢', 0) / æ€»é‡‘é¢
        else:
            æ€»ä¸ªäººå æ¯” = 0
            æ€»å…¬å¸å æ¯” = 0
        
        äº¤æ˜“è®°å½• = {
            'äº¤æ˜“æ—¶é—´': äº¤æ˜“æ—¥æœŸ.strftime('%Y-%m-%d %H:%M:%S') if äº¤æ˜“æ—¥æœŸ is not None else 'æœªçŸ¥æ—¶é—´',
            'èµ„é‡‘æ± åç§°': æŠ•èµ„äº§å“ç¼–å·,
            'å…¥é‡‘': 0,
            'å‡ºé‡‘': é‡‘é¢,
            'æ€»ä½™é¢': äº§å“ä¿¡æ¯['æ€»é‡‘é¢'],
            'å•ç¬”èµ„é‡‘å æ¯”': f"ä¸ªäºº{ä¸ªäººå æ¯”:.1%}ï¼Œå…¬å¸{å…¬å¸å æ¯”:.1%}",
            'æ€»èµ„é‡‘å æ¯”': f"ä¸ªäºº{æ€»ä¸ªäººå æ¯”:.1%}ï¼Œå…¬å¸{æ€»å…¬å¸å æ¯”:.1%}",
            'è¡Œä¸ºæ€§è´¨': f"å‡ºé‡‘ï¼ˆä¸ªäºº{ä¸ªäººè¿”è¿˜:,.0f}ï¼Œå…¬å¸{å…¬å¸è¿”è¿˜:,.0f}ï¼Œæ”¶ç›Š{æ”¶ç›Š:,.0f}ï¼‰",
            'ç´¯è®¡ç”³è´­': äº§å“ä¿¡æ¯['ç´¯è®¡ç”³è´­'],
            'ç´¯è®¡èµå›': äº§å“ä¿¡æ¯['ç´¯è®¡èµå›']
        }
        self._åœºå¤–èµ„é‡‘æ± è®°å½•.append(äº¤æ˜“è®°å½•)
        
        å‰ç¼€ = æŠ•èµ„äº§å“ç¼–å·.split('-')[0]
        return ä¸ªäººå æ¯”, å…¬å¸å æ¯”, f"{å‰ç¼€}èµå›-{æŠ•èµ„äº§å“ç¼–å·}ï¼šä¸ªäºº{ä¸ªäººè¿”è¿˜:,.2f}ï¼Œå…¬å¸{å…¬å¸è¿”è¿˜:,.2f}"
    
    def è·å–çŠ¶æ€æ‘˜è¦(self) -> Dict[str, Any]:
        """è·å–è¿½è¸ªå™¨çŠ¶æ€æ‘˜è¦"""
        return {
            'ä¸ªäººä½™é¢': Config.format_number(self._ä¸ªäººä½™é¢),
            'å…¬å¸ä½™é¢': Config.format_number(self._å…¬å¸ä½™é¢),
            'æ€»ä½™é¢': Config.format_number(self._ä¸ªäººä½™é¢ + self._å…¬å¸ä½™é¢),
            'æŠ•èµ„äº§å“æ•°é‡': len(self._æŠ•èµ„äº§å“èµ„é‡‘æ± ),
            'ç´¯è®¡æŒªç”¨é‡‘é¢': Config.format_number(self._ç´¯è®¡æŒªç”¨é‡‘é¢),
            'ç´¯è®¡å«ä»˜é‡‘é¢': Config.format_number(self._ç´¯è®¡å«ä»˜é‡‘é¢),
            'ç´¯è®¡éæ³•æ‰€å¾—': Config.format_number(self._ç´¯è®¡éæ³•æ‰€å¾—),
            'ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘': Config.format_number(self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘),
            'ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘': Config.format_number(self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘),
            'æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦': Config.format_number(self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦),
            'æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦': Config.format_number(self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦),
            'å·²åˆå§‹åŒ–': self._å·²åˆå§‹åŒ–,
            'èµ„é‡‘ç¼ºå£': Config.format_number(self._ç´¯è®¡æŒªç”¨é‡‘é¢ - self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘ - self._ç´¯è®¡å«ä»˜é‡‘é¢)
        }
    
    def è·å–å½“å‰èµ„é‡‘å æ¯”(self) -> Tuple[float, float]:
        """è·å–å½“å‰ä¸ªäººå’Œå…¬å¸èµ„é‡‘å æ¯”"""
        total_balance = self._ä¸ªäººä½™é¢ + self._å…¬å¸ä½™é¢
        if total_balance == 0:
            return 0, 0
        return self._ä¸ªäººä½™é¢ / total_balance, self._å…¬å¸ä½™é¢ / total_balance
    
    def ç”Ÿæˆåœºå¤–èµ„é‡‘æ± è®°å½•Excel(self, æ–‡ä»¶å: str = "åœºå¤–èµ„é‡‘æ± è®°å½•.xlsx") -> None:
        """ç”Ÿæˆåœºå¤–èµ„é‡‘æ± è®°å½•Excel"""
        if not self._åœºå¤–èµ„é‡‘æ± è®°å½•:
            audit_logger.info("æ²¡æœ‰åœºå¤–èµ„é‡‘æ± è®°å½•ï¼Œè·³è¿‡Excelç”Ÿæˆ")
            return
        
        try:
            import pandas as pd
            # åˆ›å»ºDataFrame
            df = pd.DataFrame(self._åœºå¤–èµ„é‡‘æ± è®°å½•)
            
            # æŒ‰èµ„é‡‘æ± åç§°åˆ†ç»„ï¼Œæ¯ç»„å†…æŒ‰æ—¶é—´æ’åº
            if len(df) > 0:
                df['äº¤æ˜“æ—¶é—´_æ’åº'] = pd.to_datetime(df['äº¤æ˜“æ—¶é—´'], errors='coerce')
                # å…ˆæŒ‰èµ„é‡‘æ± åç§°æ’åºï¼Œå†æŒ‰æ—¶é—´æ’åº
                df = df.sort_values(['èµ„é‡‘æ± åç§°', 'äº¤æ˜“æ—¶é—´_æ’åº'])
                
                # ä¸ºæ¯ä¸ªèµ„é‡‘æ± æ·»åŠ æ€»è®¡è¡Œ
                processed_data = []
                for pool_name in df['èµ„é‡‘æ± åç§°'].unique():
                    pool_data = df[df['èµ„é‡‘æ± åç§°'] == pool_name].copy()
                    processed_data.append(pool_data)
                    
                    # åˆ›å»ºæ€»è®¡è¡Œ
                    if len(pool_data) > 0:
                        last_row = pool_data.iloc[-1]
                        total_purchase = pool_data['å…¥é‡‘'].sum()
                        total_redemption = pool_data['å‡ºé‡‘'].sum()
                        
                        # è®¡ç®—æœ€ç»ˆç›ˆäºçŠ¶æ€
                        final_total_balance = last_row['æ€»ä½™é¢']
                        
                        # ä»æ€»èµ„é‡‘å æ¯”å­—ç¬¦ä¸²ä¸­æå–ä¸ªäººå’Œå…¬å¸æ¯”ä¾‹
                        ratio_str = last_row.get('æ€»èµ„é‡‘å æ¯”', last_row.get('èµ„é‡‘å æ¯”', ''))
                        final_personal_balance = final_total_balance * 0.5  # é»˜è®¤å€¼ï¼Œå¦‚æœè§£æå¤±è´¥
                        final_company_balance = final_total_balance * 0.5
                        
                        # è®¡ç®—çœŸå®ç›ˆäºï¼ˆè€ƒè™‘èµ„é‡‘æ± é‡ç½®å†å²ï¼‰
                        if pool_name in self._æŠ•èµ„äº§å“èµ„é‡‘æ± :
                            pool_info = self._æŠ•èµ„äº§å“èµ„é‡‘æ± [pool_name]
                            historical_profit = pool_info.get('ç´¯è®¡å·²å®ç°ç›ˆåˆ©', 0)
                            
                            # å½“å‰å‘¨æœŸç›ˆäº
                            if final_total_balance < 0:
                                current_profit = abs(final_total_balance)
                                current_status = "ç›ˆåˆ©"
                            elif final_total_balance > 0:
                                current_profit = -final_total_balance  # è´Ÿæ•°è¡¨ç¤ºäºæŸ
                                current_status = "äºæŸ"
                            else:
                                current_profit = 0
                                current_status = "æŒå¹³"
                            
                            # çœŸå®æ€»ç›ˆäº
                            total_real_profit = historical_profit + current_profit
                            
                            if total_real_profit > 0:
                                profit_status = "ç›ˆåˆ©"
                            elif total_real_profit < 0:
                                profit_status = "äºæŸ"
                            else:
                                profit_status = "æŒå¹³"
                            
                            profit_loss = total_real_profit
                        else:
                            # fallback to old logic
                            net_amount = total_purchase - total_redemption
                            profit_loss = final_total_balance - net_amount if net_amount != 0 else 0
                            profit_status = "ç›ˆåˆ©" if profit_loss > 0 else "äºæŸ" if profit_loss < 0 else "æŒå¹³"
                        
                        summary_row = pd.Series({
                            'äº¤æ˜“æ—¶é—´': 'â”€â”€ æ€»è®¡ â”€â”€',
                            'èµ„é‡‘æ± åç§°': f'{pool_name} æ±‡æ€»',
                            'å…¥é‡‘': f'æ€»ç”³è´­: Â¥{total_purchase:,.0f}',
                            'å‡ºé‡‘': f'æ€»èµå›: Â¥{total_redemption:,.0f}',
                            'æ€»ä½™é¢': f'æœ€ç»ˆä½™é¢: Â¥{final_total_balance:,.0f}',
                            'å•ç¬”èµ„é‡‘å æ¯”': 'â”€â”€ æ±‡æ€» â”€â”€',
                            'æ€»èµ„é‡‘å æ¯”': f'å‡€ç›ˆäº: Â¥{profit_loss:,.0f}',
                            'è¡Œä¸ºæ€§è´¨': f'çŠ¶æ€: {profit_status}',
                            'ç´¯è®¡ç”³è´­': total_purchase,
                            'ç´¯è®¡èµå›': total_redemption,
                            'äº¤æ˜“æ—¶é—´_æ’åº': pd.NaT
                        })
                        
                        processed_data.append(pd.DataFrame([summary_row]))
                        
                        # åœ¨æ¯ä¸ªæ€»è®¡è¡Œåé¢éƒ½æ·»åŠ ç©ºç™½è¡Œåˆ†éš”
                        empty_row = pd.Series({col: '' for col in df.columns})
                        empty_row['äº¤æ˜“æ—¶é—´_æ’åº'] = pd.NaT
                        processed_data.append(pd.DataFrame([empty_row]))
                
                # åˆå¹¶æ‰€æœ‰æ•°æ®
                final_df = pd.concat(processed_data, ignore_index=True)
                # åˆ é™¤ä¸´æ—¶æ’åºåˆ—
                final_df = final_df.drop('äº¤æ˜“æ—¶é—´_æ’åº', axis=1)
            else:
                final_df = df
            
            # ä¿å­˜åˆ°Excel
            final_df.to_excel(æ–‡ä»¶å, index=False, engine='openpyxl')
            audit_logger.info(f"âœ… åœºå¤–èµ„é‡‘æ± è®°å½•å·²ä¿å­˜è‡³: {æ–‡ä»¶å}")
            audit_logger.info(f"ğŸ“Š å…±è®°å½• {len(self._åœºå¤–èµ„é‡‘æ± è®°å½•)} ç¬”èµ„é‡‘æ± äº¤æ˜“ï¼ŒæŒ‰èµ„é‡‘æ± åˆ†ç»„æ’åº")
        except Exception as e:
            audit_logger.error(f"âŒ ç”Ÿæˆåœºå¤–èµ„é‡‘æ± è®°å½•Excelå¤±è´¥: {e}")
    
    # å±æ€§è®¿é—®
    @property
    def ä¸ªäººä½™é¢(self) -> float:
        return self._ä¸ªäººä½™é¢
        
    @property  
    def å…¬å¸ä½™é¢(self) -> float:
        return self._å…¬å¸ä½™é¢
        
    @property
    def ç´¯è®¡æŒªç”¨é‡‘é¢(self) -> float:
        return self._ç´¯è®¡æŒªç”¨é‡‘é¢
        
    @property
    def ç´¯è®¡å«ä»˜é‡‘é¢(self) -> float:
        return self._ç´¯è®¡å«ä»˜é‡‘é¢
        
    @property
    def ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘(self) -> float:
        return self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’å…¬å¸ä½™é¢æœ¬é‡‘
        
    @property
    def ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘(self) -> float:
        return self._ç´¯è®¡ç”±èµ„é‡‘æ± å›å½’ä¸ªäººä½™é¢æœ¬é‡‘
        
    @property
    def æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦(self) -> float:
        return self._æ€»è®¡ä¸ªäººåº”åˆ†é…åˆ©æ¶¦
        
    @property
    def æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦(self) -> float:
        return self._æ€»è®¡å…¬å¸åº”åˆ†é…åˆ©æ¶¦
        
    @property
    def å·²åˆå§‹åŒ–(self) -> bool:
        return self._å·²åˆå§‹åŒ–