# FIFO资金追踪审计系统 - 完整操作手册

## 📋 系统概述

这是一个基于FIFO（先进先出）原则的资金追踪审计系统，专为检测公款挪用和职务侵占行为而设计。系统采用模块化架构，支持复杂的投资产品追踪、资金占比计算和行为性质分析。

### 🎯 核心功能
- **FIFO资金追踪**: 按先进先出原则追踪资金流向
- **挪用垫付检测**: 自动识别公款挪用和垫付行为
- **投资产品管理**: 完整的投资产品资金池追踪
- **收益分配计算**: 按资金占比精确分配投资收益
- **流水完整性验证**: 自动检测和修复数据完整性问题
- **调试工具**: 强大的调试工具支持逐行分析

## 🏗️ 系统架构

```
FIFO资金追踪审计系统/
├── main.py                          # 主程序入口
├── config.py                        # 系统配置文件
├── debug_tool.py                    # 调试工具 (重要!)
├── requirements.txt                 # 项目依赖
├── 流水.xlsx                       # 输入数据文件
├── FIFO资金追踪结果.xlsx            # 分析结果文件
├── 投资产品交易记录.xlsx            # 投资产品交易记录
├── 流水验证错误报告.txt             # 数据完整性报告
├── models/                         # 核心业务模型
│   ├── fifo_tracker.py             # FIFO资金追踪器 (核心)
│   ├── behavior_analyzer.py        # 行为分析器
│   ├── investment_manager.py       # 投资产品管理器
│   └── flow_analyzer.py            # 资金流向分析器
├── utils/                          # 工具模块
│   ├── data_processor.py           # 数据处理器
│   ├── validators.py               # 数据验证器
│   ├── flow_integrity_validator.py # 流水完整性验证器
│   ├── logger.py                   # 日志系统
│   └── visualization.py            # 可视化工具
├── tests/                          # 测试模块
│   └── test_basic.py               # 基础测试
└── logs/                           # 日志文件
    ├── audit.log                   # 主日志
    ├── audit_detail.log            # 详细日志
    └── audit_error.log             # 错误日志
```

## 📊 数据格式要求

### 输入Excel文件必需列

系统要求输入的Excel文件必须包含以下列（**列名必须完全一致**）：

| 列名 | 数据类型 | 必填 | 说明 | 示例 |
|------|----------|------|------|------|
| 交易日期 | 日期 | ✅ | 交易发生日期 | 2023-01-15 |
| 交易时间 | 时间字符串 | ✅ | 具体交易时间 | 14:30:25 或 143025 |
| 交易收入金额 | 数值 | ✅ | 资金流入金额，无收入填0 | 50000.00 |
| 交易支出金额 | 数值 | ✅ | 资金流出金额，无支出填0 | 30000.00 |
| 余额 | 数值 | ✅ | 交易后账户余额 | 120000.00 |
| 资金属性 | 文本 | ✅ | 资金归属和性质 | 见下表详细说明 |
| 摘要 | 文本 | ❌ | 交易描述 | 购买理财产品 |
| 资金流向类型 | 文本 | ❌ | 系统自动计算 | 系统自动填充 |

### 资金属性详细说明

资金属性是系统分析的核心依据，必须严格按照以下格式填写：

#### 1. 个人资金
- **个人应收**: 个人资金流入
- **个人应付**: 个人资金流出
- **个人**: 通用个人资金标识

#### 2. 公司资金
- **公司应收**: 公司资金流入
- **公司应付**: 公司资金流出
- **公司**: 通用公司资金标识

#### 3. 投资产品格式
投资产品必须使用"前缀-产品代码"格式：

| 前缀 | 说明 | 示例 |
|------|------|------|
| 理财 | 银行理财产品 | 理财-SL100613100620 |
| 投资 | 投资类产品 | 投资-基金001 |
| 保险 | 保险类产品 | 保险-人寿001 |
| 关联银行卡 | 关联卡转账 | 关联银行卡-工行6225 |
| 资金池 | 资金池产品 | 资金池-wwy |

**注意**: 投资产品代码在系统中会自动创建独立的资金池进行追踪。

### 数据质量要求

1. **时间连续性**: 交易时间必须按时间顺序排列
2. **余额一致性**: 每行余额必须与前一行余额+收入-支出相等
3. **金额精度**: 建议保留2位小数
4. **无空值**: 关键字段不能为空
5. **编码格式**: Excel文件建议使用UTF-8编码

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装Python依赖
pip install -r requirements.txt

# 或者逐个安装核心依赖
pip install pandas numpy openpyxl matplotlib seaborn
```

### 2. 数据准备

1. 将您的银行流水数据整理成Excel格式
2. 确保包含所有必需列，列名必须完全一致
3. 按时间顺序排列所有交易记录
4. 将文件保存为 `流水.xlsx` 放在项目根目录

### 3. 运行分析

```bash
# 标准分析模式
python main.py

# 使用调试模式（推荐首次使用）
python debug_tool.py
```

### 4. 查看结果

分析完成后会生成以下文件：
- `FIFO资金追踪结果.xlsx`: 详细分析结果
- `投资产品交易记录.xlsx`: 投资产品交易记录
- `logs/`: 详细日志文件

## 🔧 调试工具详解

系统提供强大的调试工具 `debug_tool.py`，**强烈推荐首次使用或遇到问题时使用**。

### 启动调试工具

```bash
python debug_tool.py
```

### 可用调试命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `run <行数>` | 重置并运行到指定行 | `run 100` |
| `next [行数]` | 继续处理下一行或指定行数 | `next` 或 `next 5` |
| `status` | 显示当前处理状态 | `status` |
| `history [n]` | 显示最近n步处理历史 | `history 10` |
| `errors` | 显示所有错误记录 | `errors` |
| `detail <行数>` | 显示指定行的详细信息 | `detail 50` |
| `trace [n]` | 显示最近n次模块调用追踪 | `trace 20` |
| `reset` | 重置追踪器状态 | `reset` |
| `quit` | 退出调试工具 | `quit` |

### 调试工具使用场景

#### 1. 余额不匹配调试
```bash
# 启动调试
python debug_tool.py

# 运行到问题行
> run 150

# 查看详细状态
> status

# 查看错误信息
> errors

# 查看具体行信息
> detail 150
```

#### 2. 投资产品追踪调试
```bash
# 查看当前状态（包含投资产品信息）
> status

# 查看模块调用追踪
> trace 15

# 查看处理历史
> history 10
```

#### 3. 逐步调试
```bash
# 重置并逐行处理
> reset
> next
> status
> next
> status
```

## ⚙️ 配置选项

### config.py 配置说明

```python
class Config:
    # 数值精度控制
    PRECISION = 2                    # 小数位数
    EPSILON = 1e-8                   # 浮点比较精度
    BALANCE_TOLERANCE = 0.01         # 余额验证容差
    
    # 投资产品识别
    INVESTMENT_PREFIXES = [
        '理财', '投资', '保险', 
        '关联银行卡', '资金池'
    ]
    
    # 资金属性关键词
    PERSONAL_KEYWORDS = ['个人', '个人应收', '个人应付']
    COMPANY_KEYWORDS = ['公司', '公司应收', '公司应付']
    
    # 阈值设置
    LARGE_AMOUNT_THRESHOLD = 1000000  # 大额交易阈值(100万)
    
    # 显示控制
    MAX_DISPLAY_ROWS = 10            # 最大显示行数
    PROGRESS_INTERVAL = 1000         # 进度显示间隔
    
    # 文件设置
    DEFAULT_OUTPUT_FILE = "FIFO资金追踪结果.xlsx"
    DEFAULT_INPUT_FILE = "流水.xlsx"
```

### 常用配置修改

#### 1. 修改投资产品前缀
```python
# 添加新的投资产品类型
INVESTMENT_PREFIXES = [
    '理财', '投资', '保险', '关联银行卡', '资金池',
    '基金', '股票', '债券'  # 新增
]
```

#### 2. 调整精度设置
```python
# 提高计算精度
PRECISION = 4
BALANCE_TOLERANCE = 0.001
```

#### 3. 修改阈值
```python
# 降低大额交易阈值至50万
LARGE_AMOUNT_THRESHOLD = 500000
```

## 📈 输出结果详解

### 1. FIFO资金追踪结果.xlsx

包含以下关键列：

| 列名 | 说明 |
|------|------|
| 个人资金占比 | 该交易中个人资金占比 |
| 公司资金占比 | 该交易中公司资金占比 |
| 行为性质 | 挪用/垫付/正常/无交易 |
| 累计挪用 | 累计挪用金额 |
| 累计垫付 | 累计垫付金额 |
| 累计已归还公司本金 | 通过投资赎回归还的本金 |
| 个人应还 | 个人应还给公司的总金额 |
| 公司应还 | 公司应还给个人的总金额 |
| 个人余额 | 当前个人资金余额 |
| 公司余额 | 当前公司资金余额 |

### 2. 投资产品交易记录.xlsx

包含所有投资产品的详细交易记录：

| 列名 | 说明 |
|------|------|
| 资金池名称 | 投资产品名称 |
| 入金 | 申购金额 |
| 出金 | 赎回金额 |
| 总余额 | 产品总余额 |
| 个人余额 | 个人在该产品中的余额 |
| 公司余额 | 公司在该产品中的余额 |
| 资金占比 | 个人:公司资金占比 |
| 行为性质 | 该笔交易的行为性质 |
| 累计申购 | 累计申购金额 |
| 累计赎回 | 累计赎回金额 |

### 3. 最终分析结果

系统会在日志中输出最终分析结果：

```
=============================================================
FIFO资金追踪结果
=============================================================
最终余额状况:
个人余额: 12,345,678.90
公司余额: 23,456,789.01
总余额: 35,802,467.91

挪用和垫付情况:
累计挪用金额: 45,123,456.78
累计已归还公司本金: 12,345,678.90
累计垫付金额: 8,765,432.10

汇总:
个人应还公司总金额: 32,777,777.88
公司应还个人总金额: 8,765,432.10
净挪用金额: 24,012,345.78
```

## 🔍 核心模块详解

### 1. FIFO资金追踪器 (fifo_tracker.py)

**核心功能**：
- 维护FIFO队列追踪资金流向
- 计算个人/公司资金占比
- 处理投资产品申购赎回
- 计算收益分配

**关键方法**：
```python
def 处理资金流入(self, 金额, 资金属性, 时间戳):
    """处理资金流入，返回(个人占比, 公司占比, 行为性质)"""

def 处理资金流出(self, 金额, 资金属性, 时间戳):
    """处理资金流出，按FIFO原则分配"""

def 处理投资产品赎回(self, 金额, 产品属性, 时间戳):
    """处理投资产品赎回，计算收益分配"""
```

### 2. 数据处理器 (data_processor.py)

**核心功能**：
- Excel数据预处理
- 时间戳标准化
- 数据完整性验证
- 结果列初始化

**数据预处理流程**：
1. 读取Excel文件
2. 时间格式标准化
3. 按时间排序
4. 创建结果列
5. 数据验证

### 3. 流水完整性验证器 (flow_integrity_validator.py)

**核心功能**：
- 检测余额计算错误
- 自动修复时间顺序问题
- 优化同时间交易顺序
- 生成详细错误报告

**验证策略**：
- 逐行验证余额连续性
- 检测同时间交易顺序冲突
- 使用贪心算法优化交易顺序
- 生成修复建议

### 4. 投资产品管理器 (investment_manager.py)

**核心功能**：
- 创建独立投资产品资金池
- 追踪申购赎回记录
- 计算收益分配
- 维护资金占比

**投资产品追踪逻辑**：
1. 申购时按当前占比分配资金来源
2. 赎回时按占比分配赎回资金
3. 收益按资金占比分配
4. 维护完整交易记录

## 🛠️ 高级使用场景

### 1. 处理大数据集

对于超过10万条记录的数据：

```python
# 修改配置以优化性能
Config.PROGRESS_INTERVAL = 5000  # 减少进度输出
Config.MAX_DISPLAY_ROWS = 5      # 减少显示行数

# 使用调试工具分段处理
python debug_tool.py
> run 50000  # 先处理5万条
> status     # 检查状态
> run 100000 # 继续处理
```

### 2. 复杂投资产品处理

对于多层嵌套投资产品：

```python
# 在config.py中添加新的产品前缀
INVESTMENT_PREFIXES = [
    '理财', '投资', '保险', '关联银行卡', '资金池',
    '基金', '股票', '债券', '信托', 'PE基金'
]
```

### 3. 自定义验证规则

如需要特殊的验证逻辑，可以修改 `utils/validators.py`：

```python
def validate_custom_rules(self, df):
    """自定义验证规则"""
    errors = []
    # 添加您的验证逻辑
    return errors
```

### 4. 批量处理多个文件

```python
import os
from main import FIFO资金追踪分析器

analyzer = FIFO资金追踪分析器()

for file in os.listdir('.'):
    if file.endswith('.xlsx') and '流水' in file:
        output_file = f"结果_{file}"
        analyzer.分析财务数据(file, output_file)
```

## ⚠️ 常见问题与解决方案

### 1. 余额不匹配错误

**现象**: 出现"第X行余额不匹配"错误

**原因**: 
- Excel中余额计算错误
- 同时间交易顺序问题
- 浮点精度问题

**解决方案**:
```bash
# 使用调试工具定位问题
python debug_tool.py
> run X  # X为问题行号
> detail X  # 查看详细信息
> status    # 查看当前状态

# 检查是否为同时间交易问题
> trace 10  # 查看调用追踪
```

**预防措施**:
- 确保Excel余额计算正确
- 避免相同时间戳的大量交易
- 调整 `BALANCE_TOLERANCE` 容差

### 2. 投资产品识别错误

**现象**: 投资产品未被正确识别

**原因**:
- 产品名称格式不符合要求
- 缺少必要的前缀

**解决方案**:
```python
# 检查config.py中的前缀设置
INVESTMENT_PREFIXES = ['理财', '投资', '保险', '关联银行卡', '资金池']

# 确保产品名称格式为: 前缀-产品代码
# 正确: 理财-SL100613100620
# 错误: SL100613100620
```

### 3. 内存占用过高

**现象**: 处理大文件时内存不足

**解决方案**:
```python
# 1. 减少调试信息
Config.MAX_DISPLAY_ROWS = 0

# 2. 分批处理
python debug_tool.py
> run 10000  # 分批处理
> reset      # 重置状态
> run 20000
```

### 4. 编码问题

**现象**: 中文显示乱码

**解决方案**:
- 确保Excel文件保存为UTF-8编码
- 检查终端编码设置
- 使用支持中文的终端

### 5. 时间格式问题

**现象**: 时间解析错误

**解决方案**:
```python
# 检查时间格式，系统支持以下格式:
# "14:30:25" 或 "143025" 或 "14:30" 或 "1430"

# 如需支持其他格式，修改 flow_analyzer.py 中的时间解析逻辑
```

## 📝 日志系统

### 日志文件说明

| 文件 | 级别 | 内容 |
|------|------|------|
| audit.log | INFO+ | 主要处理流程 |
| audit_detail.log | DEBUG+ | 详细调试信息 |
| audit_error.log | ERROR | 错误信息 |

### 日志使用

```python
from utils.logger import audit_logger

# 不同级别的日志
audit_logger.info("处理完成")
audit_logger.warning("发现异常")
audit_logger.error("处理失败")
audit_logger.debug("调试信息")
```

### 日志分析

```bash
# 查看错误日志
tail -f logs/audit_error.log

# 搜索特定错误
grep "余额不匹配" logs/audit.log

# 查看处理进度
grep "处理进度" logs/audit.log
```

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
python -m pytest tests/

# 运行特定测试
python tests/test_basic.py

# 运行测试并生成覆盖率报告
pytest --cov=. tests/
```

### 测试覆盖

当前测试覆盖以下模块：
- 配置类功能测试
- 数据验证器测试
- 基础功能测试

### 添加自定义测试

```python
# 在 tests/ 目录下创建新的测试文件
class TestCustomFeature(unittest.TestCase):
    def test_custom_logic(self):
        # 您的测试逻辑
        pass
```

## 🔄 版本更新

### 当前版本特性
- **v2.0.0**: 模块化重构版本
  - 完整的模块化架构
  - 强大的调试工具
  - 投资产品交易记录
  - 流水完整性自动修复

### 升级指南

从旧版本升级：
1. 备份现有数据和配置
2. 安装新版本依赖
3. 更新配置文件
4. 运行测试验证

## 🤝 技术支持

### 获取帮助

1. **查看日志**: 首先检查 `logs/` 目录下的日志文件
2. **使用调试工具**: 运行 `python debug_tool.py` 进行交互式调试
3. **检查配置**: 确认 `config.py` 中的设置正确
4. **数据验证**: 确保输入数据格式符合要求

### 性能调优

1. **大数据集优化**:
   - 调整 `PROGRESS_INTERVAL`
   - 减少 `MAX_DISPLAY_ROWS`
   - 使用分批处理

2. **内存优化**:
   - 关闭调试模式
   - 减少日志输出
   - 分段处理数据

3. **精度调优**:
   - 调整 `BALANCE_TOLERANCE`
   - 修改 `PRECISION`
   - 优化浮点比较

## 📜 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。

---

**最后更新**: 2024年12月
**版本**: v2.0.0
**维护状态**: 活跃维护 