# 差额计算法完整逻辑分析与验证

> **💡 提示**: 本文档是差额计算法的详细算法分析。完整项目架构请参考 [../PROJECT_ARCHITECTURE.md](../PROJECT_ARCHITECTURE.md)

## 📊 核心逻辑理解

### 1. 差额计算法 vs FIFO的根本区别

#### FIFO方法（现有）：
- 维护资金流入队列 deque[(金额, 类型, 时间)]
- 支出时按先进先出原则从队列扣除
- 复杂的队列管理逻辑

#### 差额计算法（新方法）：
- 只维护个人余额、公司余额两个简单数值
- 支出时个人余额优先，不足部分算挪用
- 投资产品也按此原则处理

### 2. 收入处理逻辑

```python
def 差额法处理收入(金额, 资金属性):
    if 资金属性包含个人关键词:
        个人余额 += 金额
        return (1.0, 0.0, "个人资金流入")
    elif 资金属性包含公司关键词:
        公司余额 += 金额  
        return (0.0, 1.0, "公司资金流入")
    else:
        # 其他情况按当前比例分配
        总余额 = 个人余额 + 公司余额
        if 总余额 == 0:
            # 1:1分配
            个人余额 += 金额/2
            公司余额 += 金额/2
            return (0.5, 0.5, "混合资金流入")
        else:
            个人占比 = 个人余额 / 总余额
            公司占比 = 公司余额 / 总余额
            个人余额 += 金额 * 个人占比
            公司余额 += 金额 * 公司占比
            return (个人占比, 公司占比, "按比例流入")
```

### 3. 支出处理逻辑（包括投资申购）

```python
def 差额法处理支出(金额, 资金属性):
    # 个人余额优先扣除原则
    个人扣除 = min(金额, 个人余额)
    剩余金额 = 金额 - 个人扣除
    公司扣除 = min(剩余金额, 公司余额)
    挪用金额 = 公司扣除  # 使用公司资金就是挪用
    
    # 更新余额
    个人余额 -= 个人扣除
    公司余额 -= 公司扣除
    
    # 累计挪用金额
    累计挪用金额 += 挪用金额
    
    # 计算占比
    个人占比 = 个人扣除 / 金额 if 金额 > 0 else 0
    公司占比 = 公司扣除 / 金额 if 金额 > 0 else 0
    
    return (个人占比, 公司占比, 行为性质)
```

### 4. 投资产品处理逻辑

#### 投资申购：
```python
def 差额法投资申购(金额, 产品属性):
    # 按差额法扣除
    个人占比, 公司占比, _ = 差额法处理支出(金额, 产品属性)
    
    # 记录投资产品占比（用于赎回时分配）
    投资产品池[产品属性] = {
        '总金额': 金额,
        '个人占比': 个人占比,
        '公司占比': 公司占比,
        '申购时间': 当前时间
    }
```

#### 投资赎回：
```python
def 差额法投资赎回(金额, 产品属性):
    if 产品属性 not in 投资产品池:
        # 无申购记录，按个人应收处理
        个人余额 += 金额
        return (1.0, 0.0, "个人应收")
    
    # 按申购时占比分配收益
    申购信息 = 投资产品池[产品属性]
    个人占比 = 申购信息['个人占比']
    公司占比 = 申购信息['公司占比']
    
    个人收益 = 金额 * 个人占比
    公司收益 = 金额 * 公司占比
    
    # 归还到余额
    个人余额 += 个人收益
    公司余额 += 公司收益
    
    # 计算本金归还（用于抵消挪用）
    申购总额 = 申购信息['总金额']
    if 金额 <= 申购总额:
        # 部分赎回，全是本金
        归还公司本金 = 申购总额 * 公司占比 * (金额/申购总额)
    else:
        # 超额赎回，本金全部归还
        归还公司本金 = 申购总额 * 公司占比
    
    累计已归还公司本金 += 归还公司本金
    
    return (个人占比, 公司占比, 行为描述)
```

### 5. 挪用金额的两种计算

#### 累计挪用（每次都累加）：
```python
累计挪用金额 += 本次使用的公司资金
```

#### 净挪用（扣除归还后的实际挪用）：
```python
净挪用金额 = 累计挪用金额 - 累计已归还公司本金
```

## 📝 具体场景验证

### 场景1：基础支出场景
**初始状态**：个人余额20万，公司余额10万

#### 情况1.1：支出15万（个人应付）
```
支出前：个人20万，公司10万
处理：个人扣除15万，公司扣除0万
支出后：个人5万，公司10万
挪用：0万
个人占比：100%，公司占比：0%
行为性质：个人支付15万
```

#### 情况1.2：支出25万（个人应付）  
```
支出前：个人20万，公司10万
处理：个人扣除20万，公司扣除5万（挪用）
支出后：个人0万，公司5万
累计挪用：5万
个人占比：80%，公司占比：20%
行为性质：个人支付20万；挪用5万
```

#### 情况1.3：支出35万（个人应付，超出总余额）
```
支出前：个人20万，公司10万
处理：个人扣除20万，公司扣除10万（全部挪用）
支出后：个人0万，公司0万
累计挪用：10万
资金缺口：5万
个人占比：57.1%，公司占比：28.6%
行为性质：个人支付20万；挪用10万；资金缺口5万
```

### 场景2：投资产品场景
**初始状态**：个人余额20万，公司余额10万

#### 情况2.1：投资申购15万
```
申购前：个人20万，公司10万
申购处理：个人扣除15万，公司扣除0万
申购后：个人5万，公司10万
投资产品池：{
    '理财-001': {
        '总金额': 15万,
        '个人占比': 100%,
        '公司占比': 0%
    }
}
累计挪用：0万
```

#### 情况2.2：投资申购25万
```
申购前：个人20万，公司10万  
申购处理：个人扣除20万，公司扣除5万（挪用）
申购后：个人0万，公司5万
投资产品池：{
    '理财-001': {
        '总金额': 25万,
        '个人占比': 80%,  # 20/25
        '公司占比': 20%   # 5/25
    }
}
累计挪用：5万
```

#### 情况2.3：投资赎回30万（基于情况2.2）
```
赎回前：个人0万，公司5万，累计挪用5万
按占比分配：个人收益24万(30*80%), 公司收益6万(30*20%)
赎回后：个人24万，公司11万
收益分析：总收益5万（30-25），个人收益4万，公司收益1万
本金归还：公司本金全部归还5万
累计已归还公司本金：5万
净挪用：5万 - 5万 = 0万（完全归还）
```

### 场景3：公司支出场景
**当前状态**：个人余额24万，公司余额11万

#### 情况3.1：公司支出8万（公司应付）
```
支出前：个人24万，公司11万
处理：个人扣除0万，公司扣除8万
支出后：个人24万，公司3万
个人占比：0%，公司占比：100%
行为性质：公司支付8万
```

#### 情况3.2：公司支出15万（公司应付）
```
支出前：个人24万，公司11万
由于是公司支出但公司余额不足：
个人垫付：15万 - 11万 = 4万
处理：个人扣除4万（垫付），公司扣除11万
支出后：个人20万，公司0万
累计垫付：4万
个人占比：26.7%，公司占比：73.3%
行为性质：垫付4万；公司支付11万
```

## 🔍 关键确认点

1. **收入分配**：是否继续按资金属性关键词分配？
2. **投资占比记录**：申购时的占比是否正确记录用于赎回？
3. **挪用计算**：累计挪用vs净挪用的理解是否准确？
4. **垫付处理**：公司支出不足时个人垫付的逻辑是否正确？
5. **资金缺口**：支出超过总余额时如何处理？

请确认这些逻辑和例子是否符合您的预期！